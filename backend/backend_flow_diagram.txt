╔══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                           LOCAL LLM BACKEND FLOW DIAGRAM                                         ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              1. APPLICATION STARTUP                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
AIzaSyAUwIZJSoHYFp2IZQs1NMdBVH-78yHk6tI
┌─────────────────┐
│    main.py      │
│                 │
│ • Load ENV vars │
│ • Get config    │
│ • Create app    │
│ • Start server  │
└─────────┬───────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                        app_factory.py                                                             │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │  Configuration  │  │     Logging     │  │      CORS       │  │   Blueprints    │                           │
│  │                 │  │                 │  │                 │  │                 │                           │
│  │ • Dev/Prod      │  │ • API Logger    │  │ • Cross-origin  │  │ • API routes    │                           │
│  │ • Environment   │  │ • Error logs    │  │ • Headers       │  │ • DeepSeek      │                           │
│  │ • Settings      │  │ • Performance   │  │ • Security      │  │ • Health checks │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                                                   │
│  │  Model Manager  │  │   LLM Service   │  │ Concurrency Mgr │                                                   │
│  │                 │  │                 │  │                 │                                                   │
│  │ • Model loading │  │ • Text gen      │  │ • Thread pool   │                                                   │
│  │ • File handling │  │ • Model pool    │  │ • Queue mgmt    │                                                   │
│  │ • Metadata      │  │ • Statistics    │  │ • Rate limiting │                                                   │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                                                   │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              2. REQUEST FLOW                                                       │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│     CLIENT      │
│                 │
│ • Web Browser   │
│ • API Client    │
│ • HTTP Request  │
└─────────┬───────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                       FLASK ROUTER                                                                │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │   GET /         │  │ GET /api/v1/    │  │ POST /api/v1/   │  │ GET /api/       │                           │
│  │                 │  │     models      │  │     generate    │  │   deepseek/     │                           │
│  │ • API docs      │  │                 │  │                 │  │    models       │                           │
│  │ • Endpoints     │  │ • List models   │  │ • Text gen      │  │                 │                           │
│  │ • Examples      │  │ • Model info    │  │ • GGUF models   │  │ • DeepSeek list │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │ POST /api/v1/   │  │ POST /api/      │  │ GET /api/v1/    │  │ DELETE /api/v1/ │                           │
│  │     models      │  │   deepseek/     │  │     health      │  │   models/<name> │                           │
│  │                 │  │   generate      │  │                 │  │                 │                           │
│  │ • Upload model  │  │ • DeepSeek gen  │  │ • Status check  │  │ • Remove model  │                           │
│  │ • File upload   │  │ • Large context │  │ • Performance   │  │ • Cleanup       │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           3. GGUF MODEL PROCESSING                                                 │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│ POST /api/v1/   │
│   generate      │
└─────────┬───────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    api/routes.py                                                                  │
│                                                                                                                   │
│  ┌─────────────────────────────────────┐                                                                         │
│  │        RouteHandlers                │                                                                         │
│  │                                     │                                                                         │
│  │  • generate_response()              │                                                                         │
│  │  • Validate request                 │                                                                         │
│  │  • Extract parameters               │                                                                         │
│  │  • Forward to LLMService            │                                                                         │
│  └─────────────────┬───────────────────┘                                                                         │
└─────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                  services/llm_service.py                                                          │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │   Statistics    │  │   Model Pool    │  │   Generation    │  │   Response      │                           │
│  │                 │  │                 │  │                 │  │                 │                           │
│  │ • Update stats  │  │ • Get instance  │  │ • Prompt tmpl   │  │ • Return to     │                           │
│  │ • Track usage   │  │ • Check avail   │  │ • LLMChain      │  │   pool          │                           │
│  │ • Concurrency   │  │ • Create new    │  │ • LlamaCpp      │  │ • Format JSON   │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
│                                     │                                                                             │
│                                     ▼                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                services/model_pool.py                                                       │  │
│  │                                                                                                             │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                                            │  │
│  │  │ Pool Management │  │ Model Instances │  │ Resource Mgmt   │                                            │  │
│  │  │                 │  │                 │  │                 │                                            │  │
│  │  │ • Available     │  │ • LlamaCpp obj  │  │ • Memory opt    │                                            │  │
│  │  │ • In-use        │  │ • Model path    │  │ • Lifecycle     │                                            │  │
│  │  │ • Create new    │  │ • Parameters    │  │ • Cleanup       │                                            │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘                                            │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                          4. DEEPSEEK MODEL PROCESSING                                              │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│ POST /api/      │
│   deepseek/     │
│   generate      │
└─────────┬───────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                             DeepSeekLLM/deepseek_routes.py                                                        │
│                                                                                                                   │
│  ┌─────────────────────────────────────┐                                                                         │
│  │     generate_text_endpoint()        │                                                                         │
│  │                                     │                                                                         │
│  │  • Validate request                 │                                                                         │
│  │  • Extract parameters               │                                                                         │
│  │  • Forward to DeepSeekService       │                                                                         │
│  └─────────────────┬───────────────────┘                                                                         │
└─────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              DeepSeekLLM/deepseek_service.py                                                      │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │   Validation    │  │   Model Cache   │  │   Model Load    │  │   Generation    │                           │
│  │                 │  │                 │  │                 │  │                 │                           │
│  │ • Parameters    │  │ • Check cache   │  │ • Load if new   │  │ • Forward to    │                           │
│  │ • Model exists  │  │ • Thread-safe   │  │ • Model path    │  │   services      │                           │
│  │ • Limits        │  │ • LRU eviction  │  │ • Config        │  │ • Return resp   │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
│                                     │                                                                             │
│                                     ▼                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                               DeepSeekLLM/services.py                                                       │  │
│  │                                                                                                             │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                      │  │
│  │  │ Context Handling│  │   Parameters    │  │ LlamaCpp Init   │  │   Generation    │                      │  │
│  │  │                 │  │                 │  │                 │  │                 │                      │  │
│  │  │ • Large context │  │ • max_tokens    │  │ • DeepSeek cfg  │  │ • Execute       │                      │  │
│  │  │ • Auto chunking │  │ • temperature   │  │ • Threading     │  │ • Streaming     │                      │  │
│  │  │ • Overlap mgmt  │  │ • top_p, top_k  │  │ • Memory map    │  │ • Return JSON   │                      │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                      │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                            5. CONCURRENCY MANAGEMENT                                               │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                             services/concurrency_manager.py                                                       │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │ Request Queue   │  │ ThreadPool Exec │  │ Request Track   │  │ Resource Mgmt   │                           │
│  │                 │  │                 │  │                 │  │                 │                           │
│  │ • MAX_CONC: 10  │  │ • CPU intensive │  │ • Active reqs   │  │ • Memory mon    │                           │
│  │ • MAX_WORK: 4   │  │ • Worker threads│  │ • Statistics    │  │ • Queue overflow│                           │
│  │ • REQ_TIMEOUT   │  │ • Load balance  │  │ • Performance   │  │ • Graceful stop │                           │
│  │ • QUEUE_TIMEOUT │  │ • Task distrib  │  │ • Monitoring    │  │ • Cleanup       │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
│                                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                    Request Flow                                                             │  │
│  │                                                                                                             │  │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐            │  │
│  │  │   Receive   │───▶│  Queue      │───▶│  Execute    │───▶│   Process   │───▶│   Return    │            │  │
│  │  │   Request   │    │  Request    │    │  Worker     │    │   LLM       │    │  Response   │            │  │
│  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘            │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                             6. MODEL MANAGEMENT                                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                models/model_manager.py                                                             │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │ GGUF Models     │  │ DeepSeek Models │  │ Model Ops       │  │ Model Pool      │                           │
│  │                 │  │                 │  │                 │  │                 │                           │
│  │ • ./models/     │  │ • ./DeepSeek/   │  │ • Upload new    │  │ • Pool size     │                           │
│  │ • gpt4all       │  │   model/        │  │ • List avail    │  │ • Instance mgmt │                           │
│  │ • Llama-3.2     │  │ • DeepSeek-R1-* │  │ • Delete        │  │ • Memory opt    │                           │
│  │ • Mistral-7b    │  │ • Various quant │  │ • Sync fs       │  │ • Reuse conn    │                           │
│  │ • models_list   │  │ • .gguf format  │  │ • Get info      │  │ • Lifecycle     │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
│                                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                    Model Storage                                                            │  │
│  │                                                                                                             │  │
│  │  ┌─────────────────────┐                           ┌─────────────────────┐                                │  │
│  │  │     GGUF Models     │                           │   DeepSeek Models   │                                │  │
│  │  │                     │                           │                     │                                │  │
│  │  │ • File management   │                           │ • Specialized LLMs  │                                │  │
│  │  │ • Metadata tracking │                           │ • Large context     │                                │  │
│  │  │ • JSON config       │                           │ • Reasoning models  │                                │  │
│  │  │ • Size monitoring   │                           │ • Quantized forms   │                                │  │
│  │  └─────────────────────┘                           └─────────────────────┘                                │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              7. LOGGING & MONITORING                                               │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                utils/logger.py & logs/                                                             │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │ API Req Logging │  │   Log Files     │  │  Log Config     │  │ Monitor Endpts  │                           │
│  │                 │  │                 │  │                 │  │                 │                           │
│  │ • Req/Resp det  │  │ • api.log       │  │ • Max: 10MB     │  │ • /stats        │                           │
│  │ • Performance   │  │ • errors.log    │  │ • Backup: 5     │  │ • /stats/conc   │                           │
│  │ • Error track   │  │ • Rotation      │  │ • Rotation      │  │ • /cache/status │                           │
│  │ • Metrics       │  │ • Structured    │  │ • Timestamps    │  │ • /health       │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
│                                                                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                  Monitoring Flow                                                            │  │
│  │                                                                                                             │  │
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                                │  │
│  │  │   Request   │───▶│    Log      │───▶│   Analyze   │───▶│   Report    │                                │  │
│  │  │   Capture   │    │   Write     │    │   Metrics   │    │   Status    │                                │  │
│  │  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘                                │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                               8. CONFIGURATION                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                           config.py                                                               │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                           │
│  │ Environment     │  │ Model Settings  │  │ DeepSeek Config │  │ Concurrency     │                           │
│  │                 │  │                 │  │                 │  │                 │                           │
│  │ • Dev/Prod      │  │ • GPU layers:40 │  │ • Max ctx:32768 │  │ • Max conc: 10  │                           │
│  │ • Debug mode    │  │ • Batch: 512    │  │ • Def ctx: 8192 │  │ • Max work: 4   │                           │
│  │ • Secret key    │  │ • Temperature   │  │ • Chunk: 4096   │  │ • Pool size: 3  │                           │
│  │ • Upload limits │  │ • Verbose mode  │  │ • Threads: 16   │  │ • Timeouts      │                           │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘                           │
│                                                                                                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                                                   │
│  │ API & CORS      │  │ Logging Config  │  │ Performance     │                                                   │
│  │                 │  │                 │  │                 │                                                   │
│  │ • API prefix    │  │ • Log dir       │  │ • Model preload │                                                   │
│  │ • CORS origins  │  │ • Max bytes     │  │ • Request queue │                                                   │
│  │ • Headers       │  │ • Backup count  │  │ • Async process │                                                   │
│  │ • Security      │  │ • API call logs │  │ • Optimizations │                                                   │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                                                   │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                               9. COMPLETE DATA FLOW                                                │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   HTTP      │───▶│   Flask     │───▶│   Route     │───▶│   Service   │───▶│   Model     │───▶│   Response  │
│   Request   │    │   Router    │    │   Handler   │    │   Layer     │    │   Engine    │    │   JSON      │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │                   │                   │                   │
       │                   ├─── CORS          ├─── Validation    ├─── Concurrency   ├─── LlamaCpp      │
       │                   ├─── Logging       ├─── Parameters    ├─── Pool Mgmt     ├─── DeepSeek      │
       │                   ├─── Auth          ├─── Error Hdl     ├─── Statistics    ├─── Generation    │
       │                   └─── Monitoring    └─── Response      └─── Resource Mgmt └─── Streaming     │
       │                                                                                                 │
       └─────────────────────────────────────────────────────────────────────────────────────────────────┘

╔══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                                KEY FEATURES                                                       ║
║                                                                                                                  ║
║ • Dual Model Support: GGUF models + DeepSeek specialized models                                                  ║
║ • Concurrent Request Processing: Up to 10 simultaneous requests                                                  ║
║ • Model Pooling: Efficient resource management and reuse                                                        ║
║ • Streaming Support: Real-time response generation                                                               ║
║ • Large Context Handling: Automatic chunking for large inputs                                                   ║
║ • RESTful API: Standard HTTP endpoints with JSON responses                                                       ║
║ • Comprehensive Logging: Request tracking and performance monitoring                                             ║
║ • CORS Support: Cross-origin resource sharing enabled                                                           ║
║ • Hot-swappable Models: Upload/delete models without restart                                                     ║
║ • Health Monitoring: System status and performance metrics                                                      ║
║ • Thread Safety: Concurrent request handling with proper locking                                                ║
║ • Error Recovery: Graceful error handling and fallback mechanisms                                               ║
╚══════════════════════════════════════════════════════════════════════════════════════════════════════════════════╝
